<!DOCTYPE html>
<html>
<head>
    <title>Invoice Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="container mt-5">

<h2>Invoice Details</h2>

<div id="invoice-data">
    Loading...
</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="number" id="paymentAmount" class="form-control" placeholder="Enter amount">
        <div id="paymentError" class="text-danger mt-2"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success" onclick="submitPayment()">Submit</button>
      </div>
    </div>
  </div>
</div>

<script>
    const invoiceId = {{ invoice_id }};

    fetch(`/api/invoices/${invoiceId}/`)
    .then(response => response.json())
    .then(data => {
        displayInvoice(data);
    });

    function displayInvoice(data) {
        let html = `
            <h4>Invoice #: ${data.invoiceNumber}</h4>
            <p><strong>Customer:</strong> ${data.customerName}</p>
            <p><strong>Status:</strong> ${data.status}</p>
            <p><strong>Total:</strong> ₹${data.total}</p>
            <p><strong>Amount Paid:</strong> ₹${data.amountPaid}</p>
            <p><strong>Balance Due:</strong> ₹${data.balanceDue}</p>
            <hr>
            <h5>Line Items</h5>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Line Total</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.lines.forEach(line => {
            html += `
                <tr>
                    <td>${line.description}</td>
                    <td>${line.quantity}</td>
                    <td>₹${line.unitPrice}</td>
                    <td>₹${line.lineTotal}</td>
                </tr>
            `;
        });

        html += `
                </tbody>
            </table>

            <h5>Payments</h5>

            <button class="btn btn-primary mb-3" 
                    data-bs-toggle="modal" 
                    data-bs-target="#paymentModal">
                Add Payment
            </button>

            <ul>
        `;

        data.payments.forEach(payment => {
            html += `<li>₹${payment.amount} on ${payment.paymentDate}</li>`;
        });

        html += `</ul>`;

        document.getElementById("invoice-data").innerHTML = html;
    }

    function submitPayment() {
        const amount = document.getElementById("paymentAmount").value;

        fetch(`/api/invoices/${invoiceId}/payments/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ amount: amount })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById("paymentError").innerText = data.error;
            } else {
                location.reload();
            }
        });
    }
</script>

<!-- Bootstrap JS must be OUTSIDE script -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>